<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Operaciones aritméticas con OpenCV.js</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 0.2rem;
    }
    .row {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .panel {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
    }
    canvas {
      border: 1px solid #999;
      margin-top: 5px;
      max-width: 100%;
    }
    label {
      font-weight: bold;
    }
    .controls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
    }
    select {
      padding: 4px;
    }
  </style>
</head>
<body>
  <h1>Operaciones aritméticas con OpenCV.js</h1>
  <p>
    Sube dos imágenes del mismo tamaño y aplica operaciones de suma, resta y bit a bit
    usando <code>cv.add</code>, <code>cv.subtract</code>, <code>cv.bitwise_* </code>.
  </p>

  <div class="row">
    <div class="panel">
      <label for="fileInput1">Imagen 1:</label><br>
      <input type="file" id="fileInput1" accept="image/*"><br>
      <canvas id="canvasInput1"></canvas>
    </div>

    <div class="panel">
      <label for="fileInput2">Imagen 2:</label><br>
      <input type="file" id="fileInput2" accept="image/*"><br>
      <canvas id="canvasInput2"></canvas>
    </div>

    <div class="panel">
      <label>Resultado:</label><br>
      <canvas id="canvasOutput"></canvas>

      <div class="controls">
        <select id="operationSelect">
          <option value="add">Suma (cv.add)</option>
          <option value="sub">Resta (cv.subtract)</option>
          <option value="and">Bitwise AND</option>
          <option value="or">Bitwise OR</option>
          <option value="xor">Bitwise XOR</option>
          <option value="not1">Bitwise NOT imagen 1</option>
          <option value="not2">Bitwise NOT imagen 2</option>
        </select>
        <button id="runButton">Ejecutar operación</button>
      </div>
    </div>
  </div>

  <!-- Carga OpenCV.js (puedes usar tu propia copia local si quieres) -->
  <script async src="https://docs.opencv.org/3.4/opencv.js" onload="onOpenCvReady();" ></script>

  <script>
    let img1Loaded = false;
    let img2Loaded = false;

    const fileInput1 = document.getElementById('fileInput1');
    const fileInput2 = document.getElementById('fileInput2');
    const canvas1 = document.getElementById('canvasInput1');
    const canvas2 = document.getElementById('canvasInput2');
    const canvasOut = document.getElementById('canvasOutput');
    const opSelect = document.getElementById('operationSelect');
    const runButton = document.getElementById('runButton');

    function loadImageToCanvas(fileInput, canvas, callback) {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      const ctx = canvas.getContext('2d');

      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          callback && callback();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    fileInput1.addEventListener('change', () => {
      loadImageToCanvas(fileInput1, canvas1, () => {
        img1Loaded = true;
        // sincronizar tamaño del canvas de salida
        if (img1Loaded && img2Loaded) {
          canvasOut.width = Math.min(canvas1.width, canvas2.width);
          canvasOut.height = Math.min(canvas1.height, canvas2.height);
        }
      });
    });

    fileInput2.addEventListener('change', () => {
      loadImageToCanvas(fileInput2, canvas2, () => {
        img2Loaded = true;
        if (img1Loaded && img2Loaded) {
          canvasOut.width = Math.min(canvas1.width, canvas2.width);
          canvasOut.height = Math.min(canvas1.height, canvas2.height);
        }
      });
    });

    function onOpenCvReady() {
      console.log('OpenCV.js listo');
      // Habilitar el botón solo cuando OpenCV esté cargado
      runButton.disabled = false;
    }

    function runOperation() {
      if (!img1Loaded && !['not2'].includes(opSelect.value)) {
        alert('Primero sube la imagen 1');
        return;
      }
      if (!img2Loaded && !['not1'].includes(opSelect.value)) {
        // algunas operaciones solo necesitan una imagen
        if (!['not1'].includes(opSelect.value)) {
          alert('Primero sube la imagen 2');
          return;
        }
      }

      let src1 = null, src2 = null, dst = null, mask = null;
      try {
        const width = canvasOut.width;
        const height = canvasOut.height;

        if (['not1', 'not2'].includes(opSelect.value)) {
          // solo una imagen
          const canvasSrc = (opSelect.value === 'not1') ? canvas1 : canvas2;
          src1 = cv.imread(canvasSrc);
          dst = new cv.Mat();
          cv.bitwise_not(src1, dst);
        } else {
          // dos imágenes
          src1 = cv.imread(canvas1);
          src2 = cv.imread(canvas2);

          // Recortar al tamaño mínimo común por si son diferentes
          if (src1.rows !== src2.rows || src1.cols !== src2.cols) {
            const minRows = Math.min(src1.rows, src2.rows);
            const minCols = Math.min(src1.cols, src2.cols);
            src1 = src1.roi(new cv.Rect(0, 0, minCols, minRows));
            src2 = src2.roi(new cv.Rect(0, 0, minCols, minRows));
          }

          dst = new cv.Mat();
          mask = new cv.Mat();
          let dtype = -1;

          switch (opSelect.value) {
            case 'add':
              cv.add(src1, src2, dst, mask, dtype);
              break;
            case 'sub':
              cv.subtract(src1, src2, dst, mask, dtype);
              break;
            case 'and':
              cv.bitwise_and(src1, src2, dst, mask);
              break;
            case 'or':
              cv.bitwise_or(src1, src2, dst, mask);
              break;
            case 'xor':
              cv.bitwise_xor(src1, src2, dst, mask);
              break;
          }
        }

        cv.imshow('canvasOutput', dst);
      } catch (err) {
        console.error(err);
        alert('Error ejecutando la operación. Mira la consola para más detalles.');
      } finally {
        if (src1) src1.delete();
        if (src2) src2.delete();
        if (dst) dst.delete();
        if (mask) mask.delete();
      }
    }

    runButton.addEventListener('click', runOperation);
  </script>
</body>
</html>
